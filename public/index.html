<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>RaT | Slate Blur</title>
    <style>
        :root { --bg: #0f172a; --glass: rgba(30, 41, 59, 0.7); --accent: #10b981; --text: #f1f5f9; }
        body { margin: 0; background: radial-gradient(circle at top right, #1e293b, #0f172a); color: var(--text); font-family: sans-serif; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 320px; background: var(--glass); backdrop-filter: blur(20px); padding: 2rem; display: flex; flex-direction: column; border-right: 1px solid rgba(255,255,255,0.1); }
        .viewport { flex: 1; display: flex; justify-content: center; align-items: center; position: relative; }
        .phone-frame { border: 12px solid #334155; border-radius: 40px; overflow: hidden; background: #000; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        canvas { display: block; max-height: 75vh; width: auto; cursor: crosshair; }
        .nav-bar { background: #000; display: flex; justify-content: space-around; padding: 15px; border-top: 1px solid #333; }
        .btn { background: none; border: none; color: #64748b; font-size: 24px; cursor: pointer; transition: 0.2s; }
        .btn:hover { color: var(--accent); }
        input { background: rgba(0,0,0,0.3); border: 1px solid #334155; padding: 12px; color: white; border-radius: 8px; width: 100%; box-sizing: border-box; margin-top: auto; }
        input:focus { outline: none; border-color: var(--accent); }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2 style="color:var(--accent); margin-top:0;">RaT CONTROL</h2>
        <div id="status" style="color:#ef4444; font-weight:bold;">● Disconnected</div>
        <p style="font-size:12px; color:#94a3b8;">Session ID: <span id="sess">...</span></p>
        <input type="text" id="kb" placeholder="Remote Keyboard (Type & Enter)">
    </div>

    <div class="viewport">
        <div class="phone-frame">
            <canvas id="screen"></canvas>
            <div class="nav-bar">
                <button class="btn" onclick="send('key','recent')">▢</button>
                <button class="btn" onclick="send('key','home')">○</button>
                <button class="btn" onclick="send('key','back')">◁</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const canvas = document.getElementById('screen');
        const ctx = canvas.getContext('2d');
        let isDown = false, sX, sY;

        socket.emit("identify", "controller");

        socket.on("connect", () => document.getElementById('sess').innerText = socket.id);
        
        socket.on("display_frame", (data) => {
            document.getElementById('status').innerText = "● Online";
            document.getElementById('status').style.color = "#10b981";
            const img = new Image();
            img.onload = () => { canvas.width = img.width; canvas.height = img.height; ctx.drawImage(img, 0, 0); };
            img.src = "data:image/jpeg;base64," + data;
        });

        // Touch Handling
        canvas.onmousedown = e => {
            const r = canvas.getBoundingClientRect();
            sX = (e.clientX - r.left) / r.width; sY = (e.clientY - r.top) / r.height;
            isDown = true;
        };
        canvas.onmouseup = e => {
            if(!isDown) return;
            const r = canvas.getBoundingClientRect();
            const eX = (e.clientX - r.left) / r.width; const eY = (e.clientY - r.top) / r.height;
            const dist = Math.sqrt((eX-sX)**2 + (eY-sY)**2);
            // If movement is tiny, it's a Tap. If large, it's a Swipe.
            if(dist < 0.02) socket.emit("send_command", {action:"tap", x:sX, y:sY});
            else socket.emit("send_command", {action:"swipe", x1:sX, y1:sY, x2:eX, y2:eY});
            isDown = false;
        };

        function send(a, v) { socket.emit("send_command", {action:a, value:v}); }
        
        document.getElementById('kb').addEventListener('keydown', (e) => {
            if(e.key === 'Enter') {
                socket.emit("send_command", {action:"type", text:e.target.value});
                e.target.value = '';
            }
        });
    </script>
</body>
</html>
